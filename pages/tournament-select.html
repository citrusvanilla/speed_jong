<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Select Table - Speed Jong</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/favicon.jpg">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .table-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Press Start 2P', cursive;
        }

        .table-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .table-button:active {
            transform: translateY(-1px);
        }

        .table-number {
            font-size: 2rem;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .table-label {
            font-size: 0.6rem;
            opacity: 0.9;
            line-height: 1.5;
        }
        
        /* Scrollbar styling for many tables */
        #tablesContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #tablesContainer::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        #tablesContainer::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        #tablesContainer::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            margin-top: 40px;
        }

        .back-link {
            text-align: center;
            margin-top: 30px;
        }

        .back-link a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 16px;
        }

        .back-link a:hover {
            color: white;
            text-decoration: underline;
        }

        .no-tables {
            background: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            color: #1f2937;
            font-size: 16px;
            margin-top: 30px;
            line-height: 1.6;
        }
        
        .table-button.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .table-button.full {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="screen">
        <div class="container">
            <h1 id="pageTitle">Select Your Table</h1>
            
            <div id="tournamentSelector" style="text-align: center; margin-bottom: 20px;">
                <select id="tournamentSelect" style="display: none; padding: 10px 15px; font-size: 16px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.9); font-family: 'Press Start 2P', cursive; font-size: 0.7rem;">
                    <option value="">Select Tournament...</option>
                </select>
            </div>
            
            <div id="tournamentName" style="text-align: center; color: white; font-size: 18px; margin-bottom: 10px;"></div>

            <div id="tablesContainer" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <div class="loading">Loading tables...</div>
            </div>

            <div class="back-link">
                <a href="../index.html">‚Üê Back to home</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getFirestore, 
            collection,
            doc,
            getDoc,
            getDocs,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDI0fUdOj9fLT92VEBQCs0rGPWm0cgIEhQ",
            authDomain: "speedjong-285c0.firebaseapp.com",
            projectId: "speedjong-285c0",
            storageBucket: "speedjong-285c0.firebasestorage.app",
            messagingSenderId: "282851961282",
            appId: "1:282851961282:web:942a04667587d5ee320e5b",
            measurementId: "G-GYKFD28ZLH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentTournamentId = null;
        let tournaments = [];

        async function loadTournaments() {
            try {
                const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                
                if (tournamentsSnap.empty) {
                    document.getElementById('pageTitle').style.display = 'none';
                    document.getElementById('tournamentName').style.display = 'none';
                    document.getElementById('tablesContainer').innerHTML = 
                        '<div class="no-tables">No tournaments found. Please contact the organizer.</div>';
                    return;
                }

                // Load all tournaments, but only show active ones
                tournaments = [];
                tournamentsSnap.forEach(doc => {
                    const data = doc.data();
                    // Only include active tournaments (not setup or completed)
                    if (data.status === 'active') {
                        tournaments.push({ id: doc.id, ...data });
                    }
                });

                // If no active tournaments found
                if (tournaments.length === 0) {
                    document.getElementById('pageTitle').style.display = 'none';
                    document.getElementById('tournamentName').style.display = 'none';
                    document.getElementById('tablesContainer').innerHTML = 
                        '<div class="no-tables">No active tournaments. Please wait for the organizer to start the tournament.</div>';
                    return;
                }
                
                // Show elements if there are active tournaments
                document.getElementById('pageTitle').style.display = 'block';
                document.getElementById('tournamentName').style.display = 'block';

                // Sort by creation date (most recent first)
                tournaments.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis() || 0;
                    const bTime = b.createdAt?.toMillis() || 0;
                    return bTime - aTime;
                });

                // If multiple tournaments, show dropdown selector
                if (tournaments.length > 1) {
                    const tournamentSelect = document.getElementById('tournamentSelect');
                    tournamentSelect.style.display = 'block';
                    
                    tournamentSelect.innerHTML = tournaments.map(t => 
                        `<option value="${t.id}">${t.name} (${t.status})</option>`
                    ).join('');
                    
                    tournamentSelect.addEventListener('change', (e) => {
                        selectTournament(e.target.value);
                    });
                    
                    // Auto-select first one
                    tournamentSelect.value = tournaments[0].id;
                }

                // Load the first/most relevant tournament
                selectTournament(tournaments[0].id);
                
            } catch (error) {
                console.error('Error loading tournaments:', error);
                document.getElementById('tablesContainer').innerHTML = 
                    `<div class="no-tables">Error: ${error.message}</div>`;
            }
        }

        function selectTournament(tournamentId) {
            currentTournamentId = tournamentId;
            const tournamentData = tournaments.find(t => t.id === tournamentId);
            
            if (tournamentData) {
                document.getElementById('tournamentName').textContent = tournamentData.name;
                loadTables();
            }
        }

        async function loadTables() {
            try {
                // Check tournament status and current round
                const tournamentDoc = await getDoc(doc(db, 'tournaments', currentTournamentId));
                if (!tournamentDoc.exists()) {
                    document.getElementById('tablesContainer').innerHTML = 
                        '<div class="no-tables">Tournament not found.</div>';
                    return;
                }
                
                const tournamentData = tournamentDoc.data();
                const currentRound = tournamentData.currentRound || 0;
                const roundInProgress = tournamentData.roundInProgress || false;
                
                // Check current round status
                let roundStatus = null;
                if (currentRound > 0) {
                    const roundsSnap = await getDocs(collection(db, 'tournaments', currentTournamentId, 'rounds'));
                    roundsSnap.forEach((roundDoc) => {
                        const roundData = roundDoc.data();
                        if (roundData.roundNumber === currentRound) {
                            roundStatus = roundData.status;
                        }
                    });
                }
                
                // Check if selection is allowed (only in staging state)
                if (currentRound === 0) {
                    document.getElementById('tablesContainer').innerHTML = 
                        '<div class="no-tables">‚è≥ No round started yet.<br><br>Please wait for the organizer to set up the first round.</div>';
                    return;
                }
                
                if (roundStatus !== 'staging') {
                    const statusText = roundStatus === 'in_progress' ? 'Round is currently in progress' : 
                                      roundStatus === 'completed' ? 'Round has ended' : 'Round not ready';
                    document.getElementById('tablesContainer').innerHTML = 
                        `<div class="no-tables">üîí Table selection locked<br><br>${statusText}.<br><br>You can only select tables during the staging phase.</div>`;
                    return;
                }
                
                // Load all players to check if everyone is assigned
                const playersRef = collection(db, 'tournaments', currentTournamentId, 'players');
                const playersSnap = await getDocs(playersRef);
                
                const activePlayers = [];
                const unassignedPlayers = [];
                playersSnap.forEach((doc) => {
                    const playerData = doc.data();
                    if (!playerData.eliminated) {
                        activePlayers.push({ id: doc.id, ...playerData });
                        if (!playerData.tableId) {
                            unassignedPlayers.push(playerData.name);
                        }
                    }
                });
                
                // Check if all players are assigned
                if (unassignedPlayers.length > 0) {
                    const playersList = unassignedPlayers.slice(0, 5).join(', ');
                    const remaining = unassignedPlayers.length > 5 ? ` (and ${unassignedPlayers.length - 5} more)` : '';
                    document.getElementById('tablesContainer').innerHTML = 
                        `<div class="no-tables">‚ö†Ô∏è Not all players assigned yet<br><br>Unassigned: ${playersList}${remaining}<br><br>Please wait for the organizer to finish table assignments.</div>`;
                    return;
                }
                
                // Load tables
                const tablesRef = collection(db, 'tournaments', currentTournamentId, 'tables');
                const tablesSnap = await getDocs(tablesRef);
                
                if (tablesSnap.empty) {
                    document.getElementById('tablesContainer').innerHTML = 
                        '<div class="no-tables">No tables set up yet. Please wait for the organizer.</div>';
                    return;
                }

                const tables = [];
                tablesSnap.forEach((doc) => {
                    tables.push({ id: doc.id, ...doc.data() });
                });

                tables.sort((a, b) => a.tableNumber - b.tableNumber);
                
                // Only show tables with full assignment (4 players) and active status
                const fullTables = tables.filter(t => 
                    t.active !== false && 
                    t.players && 
                    t.players.length === 4
                );
                
                if (fullTables.length === 0) {
                    document.getElementById('tablesContainer').innerHTML = 
                        '<div class="no-tables">‚ö†Ô∏è No tables ready yet<br><br>Tables must have exactly 4 players assigned.<br><br>Please wait for the organizer to complete table assignments.</div>';
                    return;
                }

                const tablesHTML = fullTables.map(table => `
                    <button class="table-button full" onclick="selectTable('${table.id}', ${table.tableNumber})">
                        <div class="table-number">${table.tableNumber}</div>
                        <div class="table-label">‚úì Ready (4/4)</div>
                    </button>
                `).join('');

                document.getElementById('tablesContainer').innerHTML = `
                    <div class="table-grid">${tablesHTML}</div>
                `;

                // Make selectTable globally accessible
                window.selectTable = (tableId, tableNumber) => {
                    localStorage.setItem('tournamentId', currentTournamentId);
                    localStorage.setItem('tableId', tableId);
                    localStorage.setItem('tableNumber', tableNumber);
                    window.location.href = 'timer.html?mode=tournament';
                };
            } catch (error) {
                console.error('Error loading tables:', error);
                document.getElementById('tablesContainer').innerHTML = 
                    `<div class="no-tables">Error: ${error.message}</div>`;
            }
        }

        loadTournaments();
    </script>
</body>
</html>

