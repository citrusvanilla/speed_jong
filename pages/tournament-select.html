<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Select Table - Speed Jong</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/favicon.jpg">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        #tableSelect {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        #tableSelect:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        #pageTitle {
            font-size: 1.3rem;
            word-wrap: normal;
            overflow-wrap: normal;
            line-height: 1.4;
            max-width: 100%;
            padding: 0 10px;
            color: #667eea;
            font-weight: bold;
            text-align: center;
            margin: 0;
        }
        
        #pageTitleContainer {
            margin-bottom: 30px;
        }
        
        /* Scrollbar styling for many tables */

        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            margin-top: 40px;
        }

        .back-link {
            text-align: center;
            margin-top: 30px;
        }

        .back-link a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 16px;
        }

        .back-link a:hover {
            color: white;
            text-decoration: underline;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
            margin-top: 30px;
            width: 100%;
        }

        .button-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tournament-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            font-weight: normal;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s, box-shadow 0.2s;
            line-height: 1.5;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .tournament-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .tournament-btn:active {
            transform: translateY(0);
        }

        #tournamentCodeEntry {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #tournamentCodeInput {
            padding: 15px 20px;
            font-size: 1.2rem;
            border-radius: 12px;
            border: 3px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.95);
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            letter-spacing: 4px;
            text-transform: uppercase;
            max-width: 250px;
            width: 90%;
            transition: all 0.2s;
        }

        #tournamentCodeInput:focus {
            outline: none;
            border-color: white;
            background: white;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        #tournamentCodeInput::placeholder {
            letter-spacing: 2px;
            font-size: 0.8rem;
        }

        #joinButton {
            width: 100%;
            max-width: 400px;
            margin-top: 15px;
            padding: 1rem;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            font-weight: normal;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            line-height: 1.5;
            white-space: nowrap;
        }

        #joinButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        #joinButton:active:not(:disabled) {
            transform: translateY(0);
        }

        #joinButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #exitButton {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            font-weight: normal;
            color: white;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            line-height: 1.5;
        }

        #exitButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        #exitButton:active {
            transform: translateY(0);
        }

        #tournamentName {
            text-align: center;
            color: #667eea;
            font-size: 1.2rem;
            font-family: 'Press Start 2P', cursive;
            margin-bottom: 15px;
            margin-top: 10px;
            font-weight: bold;
            line-height: 1.6;
        }

        #roundInfo {
            text-align: center;
            padding: 12px 20px;
            margin: 0 auto 25px;
            border-radius: 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            max-width: 300px;
            display: none;
        }

        #roundInfo.in-progress {
            background: #dcfce7;
            color: #15803d;
            border: 2px solid #22c55e;
        }

        #roundInfo.completed {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        #roundInfo.staging {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #fbbf24;
        }

        #roundInfo.no-round {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #9ca3af;
        }

        #errorMessage {
            text-align: center;
            color: #fbbf24;
            font-size: 0.7rem;
            font-family: 'Press Start 2P', cursive;
            margin-top: 10px;
            min-height: 24px;
        }

        .no-tables {
            background: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            color: #1f2937;
            font-size: 0.75rem;
            line-height: 1.8;
            margin-top: 30px;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="screen">
        <div class="container">
            <div id="pageTitleContainer">
                <div id="pageTitlePrefix" style="font-size: 0.9rem; color: #9ca3af; text-align: center; margin-bottom: 5px; line-height: 1.4;">Enter Code</div>
                <h1 id="pageTitle" style="display: none;"></h1>
            </div>
            
            <div id="tournamentCodeEntry">
                <input type="text" 
                       id="tournamentCodeInput" 
                       placeholder="XXXX" 
                       maxlength="4" 
                       autocomplete="off"
                       spellcheck="false">
                <div id="errorMessage"></div>
                <div style="display: flex; gap: 10px; width: 100%;">
                    <a href="../index.html" id="backToHomeBtn" class="tournament-btn" style="flex: 1; margin: 0 !important; max-width: none !important; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">← Back</a>
                    <button id="joinButton" style="flex: 1; margin: 0 !important; max-width: none !important;">Join</button>
                </div>
            </div>
            
            <div id="tournamentName"></div>
            <div id="roundInfo"></div>

            <div id="tablesContainer" style="display: none;">
                <div class="form-group" style="margin-top: 20px;">
                    <select id="tableSelect" style="width: 100%; padding: 15px; font-size: 0.8rem; border-radius: 10px; border: 2px solid #e5e7eb; background-color: white; font-family: 'Press Start 2P', cursive; text-align: center;">
                        <option value="">Choose your table...</option>
                    </select>
                </div>
                <div id="noTablesMessage" class="no-tables" style="display: none;"></div>
            </div>

            <div id="tournamentActions" class="button-group" style="display: none;">
                <a href="#" id="viewAssignmentLink" class="tournament-btn">My Seat</a>
                <a href="#" id="leaderboardLink" class="tournament-btn">Leaderboard</a>
                <button id="exitButton">Exit</button>
            </div>

            <div class="back-link">
                <a href="../index.html">← Back to home</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getFirestore, 
            collection,
            doc,
            getDoc,
            getDocs,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDI0fUdOj9fLT92VEBQCs0rGPWm0cgIEhQ",
            authDomain: "speedjong-285c0.firebaseapp.com",
            projectId: "speedjong-285c0",
            storageBucket: "speedjong-285c0.firebasestorage.app",
            messagingSenderId: "282851961282",
            appId: "1:282851961282:web:942a04667587d5ee320e5b",
            measurementId: "G-GYKFD28ZLH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentTournamentId = null;
        let currentTournamentData = null;

        const tournamentCodeInput = document.getElementById('tournamentCodeInput');
        const joinButton = document.getElementById('joinButton');
        const exitButton = document.getElementById('exitButton');
        const errorMessage = document.getElementById('errorMessage');
        const tablesContainer = document.getElementById('tablesContainer');
        const tournamentName = document.getElementById('tournamentName');
        const roundInfo = document.getElementById('roundInfo');
        const pageTitle = document.getElementById('pageTitle');
        
        let tournamentUnsubscribe = null;

        // Exit tournament button
        exitButton.addEventListener('click', () => {
            // Clear tournament data
            localStorage.removeItem('tournamentId');
            localStorage.removeItem('tableId');
            localStorage.removeItem('tableNumber');
            
            // Return to home
            window.location.href = '../index.html';
        });

        // Auto-uppercase tournament code input
        tournamentCodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
            errorMessage.textContent = '';
        });

        // Handle Enter key
        tournamentCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinButton.click();
            }
        });

        // Join tournament with tournament code
        joinButton.addEventListener('click', async () => {
            const tournamentCode = tournamentCodeInput.value.trim().toUpperCase();
            
            // Validate format
            if (tournamentCode.length !== 4) {
                errorMessage.textContent = 'Please enter a 4-character code';
                return;
            }

            if (!/^[A-Z0-9]{4}$/.test(tournamentCode)) {
                errorMessage.textContent = 'Code must contain only letters and numbers';
                return;
            }

            joinButton.disabled = true;
            errorMessage.textContent = '';

            try {
                // Find tournament by tournament code (case-insensitive)
                const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                let foundTournament = null;

                tournamentsSnap.forEach((doc) => {
                    const data = doc.data();
                    if (data.tournamentCode?.toUpperCase() === tournamentCode) {
                        foundTournament = { id: doc.id, ...data };
                    }
                });

                if (!foundTournament) {
                    errorMessage.textContent = 'Invalid tournament code';
                    joinButton.disabled = false;
                    return;
                }

                // Check if tournament is active
                if (foundTournament.status !== 'active') {
                    errorMessage.textContent = 'Tournament is not active';
                    joinButton.disabled = false;
                    return;
                }

                // Valid tournament found!
                currentTournamentId = foundTournament.id;
                currentTournamentData = foundTournament;

                // Save tournament ID for other pages
                localStorage.setItem('tournamentId', foundTournament.id);

                // Hide tournament code entry, show tournament info
                document.getElementById('tournamentCodeEntry').style.display = 'none';
                const nameStartsWithThe = foundTournament.name.toLowerCase().startsWith('the ');
                const prefix = nameStartsWithThe ? 'Welcome to' : 'Welcome to the';
                document.getElementById('pageTitlePrefix').textContent = prefix;
                document.getElementById('pageTitle').textContent = foundTournament.name;
                document.getElementById('pageTitle').style.display = 'block';
                tournamentName.style.display = 'none'; // Hide separate tournament name display
                
                // Set up real-time tournament listener for round updates
                setupTournamentListener(foundTournament.id);
                
                // Initial round info display
                updateRoundInfo(foundTournament);
                
                // Show and configure tournament-specific links
                setupTournamentLinks(foundTournament.id);
                
                // Load tables
                await loadTables();
                
            } catch (error) {
                console.error('Error joining tournament:', error);
                errorMessage.textContent = 'Error: ' + error.message;
                joinButton.disabled = false;
            }
        });

        // Function to update round info display
        async function updateRoundInfo(tournamentData) {
            const currentRound = tournamentData.currentRound || 0;
            const roundInProgress = tournamentData.roundInProgress || false;
            
            if (currentRound === 0) {
                roundInfo.style.display = 'block';
                roundInfo.className = 'no-round';
                roundInfo.textContent = 'No rounds started';
                return;
            }
            
            roundInfo.style.display = 'block';
            
            // Fetch the actual round document to get its status
            try {
                const roundsSnap = await getDocs(collection(db, 'tournaments', currentTournamentId, 'rounds'));
                let roundStatus = null;
                
                roundsSnap.forEach(roundDoc => {
                    const roundData = roundDoc.data();
                    if (roundData.roundNumber === currentRound) {
                        roundStatus = roundData.status;
                    }
                });
                
                // Determine state based on round status
                if (roundStatus === 'staging') {
                    roundInfo.className = 'staging';
                    roundInfo.textContent = `Round ${currentRound} - PREPARING`;
                } else if (roundStatus === 'in_progress') {
                    roundInfo.className = 'in-progress';
                    roundInfo.textContent = `Round ${currentRound} - IN PROGRESS`;
                } else if (roundStatus === 'completed') {
                    roundInfo.className = 'completed';
                    roundInfo.textContent = `Round ${currentRound} - COMPLETED`;
                } else {
                    // No round document found, use roundInProgress flag as fallback
                    if (roundInProgress) {
                        roundInfo.className = 'in-progress';
                        roundInfo.textContent = `Round ${currentRound} - IN PROGRESS`;
                    } else {
                        roundInfo.className = 'staging';
                        roundInfo.textContent = `Round ${currentRound} - PREPARING`;
                    }
                }
            } catch (error) {
                console.error('Error fetching round status:', error);
                // Fallback to simple display
                roundInfo.className = roundInProgress ? 'in-progress' : 'staging';
                roundInfo.textContent = `Round ${currentRound}${roundInProgress ? ' - IN PROGRESS' : ' - PREPARING'}`;
            }
        }

        // Function to setup tournament listener
        function setupTournamentListener(tournamentId) {
            // Unsubscribe from previous listener if any
            if (tournamentUnsubscribe) {
                tournamentUnsubscribe();
            }
            
            // Set up real-time listener for tournament changes
            tournamentUnsubscribe = onSnapshot(doc(db, 'tournaments', tournamentId), async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentTournamentData = { id: tournamentId, ...data };
                    
                    // Update round info (async)
                    await updateRoundInfo(data);
                    
                    // Check if tournament is still active
                    if (data.status !== 'active') {
                        // Tournament is no longer active
                        errorMessage.textContent = 'Tournament is no longer active';
                        errorMessage.style.color = '#ef4444';
                    }
                }
            });
        }

        // Function to setup tournament-specific links
        function setupTournamentLinks(tournamentId) {
            const tournamentActionsDiv = document.getElementById('tournamentActions');
            const viewAssignmentLink = document.getElementById('viewAssignmentLink');
            const leaderboardLink = document.getElementById('leaderboardLink');
            
            // Set up links to pass tournament ID
            viewAssignmentLink.href = `player-view.html?tournament=${tournamentId}`;
            leaderboardLink.href = `leaderboard.html?tournament=${tournamentId}`;
            
            // Show the entire button group
            tournamentActionsDiv.style.display = 'flex';
        }

        // Check if we already have a tournament ID stored
        const savedTournamentId = localStorage.getItem('tournamentId');
        if (savedTournamentId) {
            // Auto-load if we have a saved tournament
            getDoc(doc(db, 'tournaments', savedTournamentId))
                .then((docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.status === 'active') {
                            currentTournamentId = savedTournamentId;
                            currentTournamentData = { id: savedTournamentId, ...data };
                            document.getElementById('tournamentCodeEntry').style.display = 'none';
                            const nameStartsWithThe = data.name.toLowerCase().startsWith('the ');
                            const prefix = nameStartsWithThe ? 'Welcome to' : 'Welcome to the';
                            document.getElementById('pageTitlePrefix').textContent = prefix;
                            document.getElementById('pageTitle').textContent = data.name;
                            document.getElementById('pageTitle').style.display = 'block';
                            tournamentName.style.display = 'none'; // Hide separate tournament name display
                            setupTournamentListener(savedTournamentId);
                            updateRoundInfo(data);
                            setupTournamentLinks(savedTournamentId);
                            loadTables();
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading saved tournament:', error);
                });
        }

        function loadTables() {
            try {
                tablesContainer.style.display = 'block';
                const tableSelect = document.getElementById('tableSelect');
                const noTablesMessage = document.getElementById('noTablesMessage');
                
                const tablesRef = collection(db, 'tournaments', currentTournamentId, 'tables');
                
                // Set up real-time listener for table changes
                onSnapshot(tablesRef, (snapshot) => {
                    if (snapshot.empty) {
                        tableSelect.style.display = 'none';
                        noTablesMessage.style.display = 'block';
                        noTablesMessage.textContent = 'No tables set up yet. Please wait for the organizer.';
                        return;
                    }

                    const tables = [];
                    snapshot.forEach((doc) => {
                        const tableData = { id: doc.id, ...doc.data() };
                        // Only show tables with exactly 4 players assigned
                        const playerCount = tableData.players ? tableData.players.length : 0;
                        if (playerCount === 4) {
                            tables.push(tableData);
                        }
                    });

                    if (tables.length === 0) {
                        tableSelect.style.display = 'none';
                        noTablesMessage.style.display = 'block';
                        noTablesMessage.textContent = 'No tables ready yet. Tables will appear when they have 4 players assigned.';
                        return;
                    }

                    // Sort tables by number
                    tables.sort((a, b) => a.tableNumber - b.tableNumber);

                    // Show selector, hide message
                    tableSelect.style.display = 'block';
                    noTablesMessage.style.display = 'none';

                    // Populate dropdown
                    tableSelect.innerHTML = '<option value="">Choose your table...</option>' +
                        tables.map(table => `
                            <option value="${table.id}" data-table-number="${table.tableNumber}">
                                Table ${table.tableNumber}
                            </option>
                        `).join('');
                }, (error) => {
                    console.error('Error loading tables:', error);
                    tableSelect.style.display = 'none';
                    noTablesMessage.style.display = 'block';
                    noTablesMessage.textContent = `Error: ${error.message}`;
                });
            } catch (error) {
                console.error('Error setting up tables listener:', error);
                const noTablesMessage = document.getElementById('noTablesMessage');
                noTablesMessage.style.display = 'block';
                noTablesMessage.textContent = `Error: ${error.message}`;
            }
        }
        
        // Handle table selection
        document.getElementById('tableSelect').addEventListener('change', (e) => {
            const selectedOption = e.target.selectedOptions[0];
            if (selectedOption && selectedOption.value) {
                const tableId = selectedOption.value;
                const tableNumber = selectedOption.dataset.tableNumber;
                
                localStorage.setItem('tournamentId', currentTournamentId);
                localStorage.setItem('tableId', tableId);
                localStorage.setItem('tableNumber', tableNumber);
                window.location.href = 'timer.html?mode=tournament';
            }
        });

        // Focus on tournament code input on load
        tournamentCodeInput.focus();
    </script>
</body>
</html>

